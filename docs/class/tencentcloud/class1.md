# 基于开源工具打持续交付平台实践之路

## DevOps 背景及理念

### 1. 传统模式下的软件交付

- 纯手工 
- 软件交付周期长 
- 软件质量不确定性 
- 多团队协作难度大

### 2. 当下软件发展趋势

- 微服务：原有一个系统被拆分多个
- 敏捷开发模式：需求粒度更细化
- 容器化

### 3. 什么是 DevOps

- `Development` + `Operations`，开发 + 运维一体化
- 通过一系列工具及制定一些规范，尽可能实现软件交付自动化，同时保证软件交付质量

### 4. DevOps 特点

- 自动化 
- 规范化
- 缩短交付周期
- 交付质量有保证
- 提升收益

## 工具集选型

### 1. 需求管理

- `Readmine`
- `JIRA`

### 2. 版本管理系统

- `Git`
- `SVN`

### 3. 持续集成

- `Jenkins`
- `Gitlab-CI`

### 4. 持续测试

- 单元测试

> 方法级的测试，开发需要对源码编写测试类，目的验证功能代码是否有问题，可以使用 `junit+jmock` 实现，对接到 `pipeline`

- 接口测试

> 针对对外暴露的接口/或为本系统提供服务的方法进行测试，需要编写测试案例，可以将 `Jmeter` 集成到 Jenkins 上实现接口自动化测试及结果收集

- 联调测试

> 指系统间连通性测试，需要人工介入

### 5. 持续部署

- 配置文件

> 配置文件与环境绑定，每套环境使用一套配置文件，需要对配置文件做统一管理，发布时选择对应文件或者动态替换

- 数据库脚本

> 需要将 SQL 变更文件纳入到版本管理系统中，发版时增量执行变更 sql

- 应用部署包

> 持续集成将构建包推送到制品库中按照一定规范管理起来，部署时从制品库中垃取对应版本的应用包部署

x86: 通过集成 `Ansible`实现部署任务分发，提升部署速度
容器环境：集成对接 docker 或 k8s，实现版本发布升级
云平台：对接云平台实现版本发布

## 分支策略方案

### 1. 分支管理的必要性

- 避免代码丢失
- 提高代码质量

> 设置分支权限后，feature 分支向主干分支合并需要 master 角色 review 评审，保障主干分支代码质量

- 版本控制

> 为了追溯每个版本需求/变更及其线上 bug 修改，需要设计合理的分支策略并管理到需求和部署包）

### 2. 合理分支策略的特点

- 符合业务场景

> 没有最好的，只有最合适的，设计符合自己业务场景的分支策略最为关键

- 分支层次结构清晰

> 清晰的分支层次结构，能更好的体现每个分支的功能

- 避免形式主义

> 不应该为了做分支管理而设计多层分支，导致一次提交需要合并多次，失去高效交付效果

- 权限控制

> 需要对主干分支设置相应权限，只有指定人员才有权限合并，提高代码质量

### 3. 几种场景下的分支策略

- 快速迭代中的项目

![快速迭代中的项目](http://cdn.chemputer.top/notebook/classnotebook/tencentcloud/class1/1-1.jpg)

1. master 主干分支永不消亡，不能直接 push，只有管理员有合并权限
2. Sprint 分支为迭代分支，来源于 master 分支，测试时从此分支发布版本，本次迭代开发完成由管理员合并到 master 分支，不能直接 push
3. feature 分支对应具体需求，可以与故事（Story）编号或者是任务（Task）编号关联，面向开发者，开放 push 权限

- 定期上线功能项目

![定期上线功能项目](http://cdn.chemputer.top/notebook/classnotebook/tencentcloud/class1/1-2.jpg)

1. master 主干分支永不消亡，不能直接 push，只有管理员有合并权限
2. Release 分支为上线窗口分支，来源于 master 分支，平时多开发环境，测试环境从此分支发布版本。当本次上线窗口所有功能都开发完了，依次发版开发环境/SIT 环境/UAT 环境/Rel 环境，都没有问题，才将制品升级为 release 包发布到生产环境，上线成功将本窗口分支合并到 master 分支
3. feature 分支对应具体需求，可以与故事（Story）编号或者是任务（Task）编号关联，面向开发者，开放 push 权限
4. 当生产环境出现了问题，从 master 分支拉一个 hotfix 分支，解决后合并到 master 分支

## Pipeline 设计

### 1. Pipeline 介绍

Pipeline 俗称流水线，在 Jenkins 中也被称为 Job，多个构建单元组成一个流水线，eg：代码编译，单元测试，代码扫描组成一条 pipeline

编排一个 pipeline 有以下几种方式：

1. 在 Jenkins 界面配置化实现
2. 编写 Jenkinsfile 文件（推荐，一切配置皆代码，便于快速配置）

> Jenkinsfile 是 Jenkins 可识别的脚本文件，以代码的形式将所有的构建步骤按照一定语法写入，分为 声明式 + 脚本式

### 2. Pipeline 设计

- 自动触发

开发提交代码时自动触发，主要环节有代码编译 + 单元测试 + 代码扫描，主要用来检测每次提交的代码质量

![流水线](http://cdn.chemputer.top/notebook/classnotebook/tencentcloud/class1/1-3.jpg)

- 定时触发

定时触发，主要环节 代码编译 + 单元测试 + 代码扫描 + 版本发布 + 部署 + 接口自动化测试，用于检测时间段内新代码质量及接口测试

![定时触发](http://cdn.chemputer.top/notebook/classnotebook/tencentcloud/class1/1-4.jpg)

- 手动触发

![手动触发](http://cdn.chemputer.top/notebook/classnotebook/tencentcloud/class1/1-5.jpg)

## 度量与反馈

### 1. 指标定义

- 指标定义要求

  > 1. 指标需要覆盖持续交付的整个生命周期
  > 2. 需要涉及到持续交付工具链中的每个工具

- 常见指标
  > 1. 构建成功率
  > 2. 千行 bug 率
  > 3. 代码提交数
  > 4. 单元测试覆盖率
  > 5. 红灯修复时长

### 2. 面板设计与排版

- 度量面板获取指标数据

  > 1. 直接从工具链数据库抽取
  > 2. agent 抽取指标数据到中间库，再从中间库中抽取
  > 3. 制定合理的指标数据抽取频率

- 指定数据清理周期
  > 1. 制定工具链数据库中数据清理周期
  > 2. 制定度量平台数据清理机制

### 3. 指标告警

- 针对某些特殊指标制定告警阈值
- 对接告警通知工具（eg 钉钉，邮件）
- 明确通知责任人
